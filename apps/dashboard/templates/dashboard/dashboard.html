{% extends "base.html" %}
{% load static %}

{% block title %}Панель управления | Система прогнозирования успеваемости{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container">
  <!-- LEFT SIDEBAR -->
  <article class="menu-container">
    <div class="menu-header">
      <img src="{% static 'images/logo.png' %}" alt="Logo" class="logo" />
      <span class="app-name">Base</span>
    </div>
    <nav class="menu-items">
      <a href="{% url 'dashboard' %}" class="menu-item"><img src="{% static 'images/dashboard3.png' %}" class="icon" /><span>Дашборд</span></a>
      <a href="{% url 'notification' %}" class="menu-item"><img src="{% static 'images/notification.png' %}" class="icon" /><span>Уведомления</span></a>
      <a href="{% url 'support' %}" class="menu-item"><img src="{% static 'images/support.png' %}" class="icon" /><span>Поддержка</span></a>
      <a href="{% url 'settings' %}" class="menu-item"><img src="{% static 'images/setting.png' %}" class="icon" /><span>Настройки</span></a>
    </nav>
    <div class="menu-footer">
      <a href="{% url 'logout' %}" class="menu-item logout"><img src="{% static 'images/Logout.png' %}" class="icon" /><span>Выйти</span></a>
    </div>
  </article>

  <!-- CENTER CONTENT -->
  <main class="main">
    <header class="header">
      <h1>Добро пожаловать, {{ user.username }}!</h1>
      <p>Статистика вашей успеваемости за текущий семестр.</p>
    </header>

    <div class="stats">
      <div class="stat-box">
        <p>Средняя посещаемость</p>
        <h2>{% if attendance_values %}{{ attendance_values|last|floatformat:1 }}%{% else %}0%{% endif %}</h2>
      </div>
      <div class="stat-box">
        <p>Средний балл</p>
        <h2>{% if predictions_data %}{{ predictions_data.0.predicted_score|floatformat:1 }}{% else %}0{% endif %}</h2>
      </div>
      <div class="stat-box">
        <p>Всего курсов</p>
        <h2>{{ student_courses.count }}</h2>
      </div>
    </div>

    <div class="row">
      <!-- Prediction Chart -->
      <div class="prediction">
        <h3>Прогноз успеваемости</h3>
        <div class="chart-wrapper">
          <div class="y-axis">
            <span>100%</span>
            <span>75%</span>
            <span>50%</span>
            <span>25%</span>
            <span>0%</span>
          </div>
          <div class="chart-area">
            <div class="chart">
              {% for prediction in predictions_data %}
                <div style="height: {{ prediction.predicted_score }}%;">
                  <span>{{ prediction.predicted_score|floatformat:0 }}</span>
                </div>
              {% empty %}
                <div style="height: 70%;">
                  <span>70</span>
                </div>
                <div style="height: 65%;">
                  <span>65</span>
                </div>
                <div style="height: 80%;">
                  <span>80</span>
                </div>
                <div style="height: 75%;">
                  <span>75</span>
                </div>
              {% endfor %}
            </div>
            <div class="x-axis">
              {% for prediction in predictions_data %}
                <span>{{ prediction.course|truncatechars:8 }}</span>
              {% empty %}
                <span>Курс 1</span>
                <span>Курс 2</span>
                <span>Курс 3</span>
                <span>Курс 4</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Absence Chart -->
      <div class="absence">
        <h3>Выполнение заданий</h3>
        <ul class="absence-list">
          {% for score in assignment_scores %}
            <li>
              {{ score.title }}
              <progress value="{{ score.percentage }}" max="100"></progress>
            </li>
          {% empty %}
            <li>
              Задание 1
              <progress value="75" max="100"></progress>
            </li>
            <li>
              Задание 2
              <progress value="90" max="100"></progress>
            </li>
            <li>
              Задание 3
              <progress value="60" max="100"></progress>
            </li>
            <li>
              Задание 4
              <progress value="85" max="100"></progress>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="content-box insights">
      <h3>Рекомендации</h3>
      <p>Следите за сроками выполнения заданий и активно участвуйте на занятиях для повышения общей успеваемости.</p>
      <p>Регулярное посещение и активное участие значительно увеличивают ваш прогнозируемый балл!</p>
    </div>
  </main>

  <!-- RIGHT SIDEBAR (PROFILE) -->
  <aside class="profile">
    <div class="avatar">
      <!-- Placeholder for user avatar -->
    </div>
    <div class="info">
      <h3>{{ user.username }}</h3>
      <p>{{ user.email }}</p>
      <p>{{ user.student_number }}</p>
    </div>
    <div class="courses">
      {% for student_course in student_courses %}
        <button class="{% if forloop.first %}active{% endif %}">{{ student_course.course.name }}</button>
      {% empty %}
        <button class="active">Математический анализ</button>
        <button>Введение в программирование</button>
        <button>Статистика</button>
        <button>Машинное обучение</button>
      {% endfor %}
    </div>
  </aside>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Активация кнопок курсов
  const courseButtons = document.querySelectorAll('.courses button');
  courseButtons.forEach(button => {
    button.addEventListener('click', function() {
      courseButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
    });
  });
});
</script>
{% endblock %}
